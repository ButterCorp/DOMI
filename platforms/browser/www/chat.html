<html>
    <head>
        <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; connect-src *;">
        <meta name="format-detection" content="telephone=no">
        <meta name="msapplication-tap-highlight" content="no">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
        
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="css/bootstrap-theme.min.css">
        <link rel="stylesheet" type="text/css" href="css/index.css">
    </head>
    <body>
        
         
  <div class='chat-wrapper' id="chatsc" style="overflow-y: scroll;">


        <div class='chat-message padding'>
                <img src="img/microphone.png" id="micro" style="z-index: 10000;background: white;"/>
    
        </div>

        <div id="chat1">

            <div class="row" style="margin-top:10px">
                <span id="chat1head">Sélectionnez votre réponse :</span>
            </div>

            <div class="row" style="margin-top:15px;height: 100px;">
                <div class="item" style="width:90px;height:90px;margin-left:unset;">
                    <img src="img/emoticon-square-smiling-face-with-closed-eyes.png" class="itemImg" />
                    <p class="itemTxt txt">Très bien</p>
                </div>

                <div class="item" style="width:90px;height:90px;">
                    <img src="img/sleepy-emoticon-square-face.png" class="itemImg" />
                    <p class="itemTxt txt">Contrarié</p>
                </div>

                <div class="item" style="width:90px;height:90px;position: relative;top: -32px;">
                    <p class="orange txt">Oui</p>
                </div>
            </div>

            <div class="row" style="margin-top:10px;height: 100px;">
                <div class="item" style="width:90px;height:90px;margin-left:unset;">
                    <img src="img/teardrop-falling-on-sad-emoticon-face.png" class="itemImg" />
                    <p class="itemTxt txt">Bonjour</p>
                </div>

                <div class="item" style="width:90px;height:90px;">
                    <img src="img/annulled-emoticon-square-face.png" class="itemImg" />
                    <p class="itemTxt txt">Malade</p>
                </div>

                <div class="item" style="width:90px;height:90px;position: relative;top: -32px;">
                    <p class="orange txt">Non</p>
                </div>
            </div>
        </div>
    
      </div>
            
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript" src="js/bootstrap.min.js"></script>
        <script>


            $( document ).ready(function() {

                var reponse = "Bonjour, comment allez-vous ?";

                var d = new Date();
                var n = d.getMinutes();
                var h = d.getHours();

                var day = d.getDate();
                var month = d.getMonth();



                    $('.chat-message.padding').append("<div class='chat-message chat-message-recipient'>" +

                        "<div class='chat-message-wrapper'>" +
                        "<div class='chat-message-content'>" +
                            "<p>"+reponse+"</p>" +
                        "</div>" +

                        "<div class='chat-details'>" +
                            "<span class='chat-message-localization font-size-small'>"+h+":"+n+"</span>" +
                            "<span class='chat-message-read-status font-size-small'>"+day+"/"+month+"</span>" +
                        "</div>" +

                        "</div>" +
                    "</div>");
            });

            $('.item').on('click', function(){
                var texte = $(this).text();

                var d = new Date();
                var n = d.getMinutes();
                var h = d.getHours();

                var day = d.getDate();
                var month = d.getMonth();

                $('.chat-message.padding').append("<div class='chat-message chat-message-sender'>" +
                    
                        "<div class='chat-message-wrapper'>" +
                        "<div class='chat-message-content'>" +
                            "<p>"+ texte +"</p>" +
                        "</div>" +

                    " <div class='chat-details'>" +
                            "<span class='chat-message-localisation font-size-small'>"+h+":"+n+"</span>" +
                        " <span class='chat-message-read-status font-size-small'>"+day+"/"+month+"</span>" +
                        "</div>" +
                        "</div>" + 
                    "</div>");

                    var wtf = $('#chatsc');
                    var height = wtf[0].scrollHeight;
                    console.log(height);
                    wtf.scrollTop(height);

                    setTimeout(sendText(texte), 3000);

                });

                function sendText(query_text) {
                    try {
                        ApiAIPlugin.requestText(
                            {
                                contexts: [localStorage.getItem('id')],
                                query: query_text
                            },
                            function (response) {
                                
                                var reponse = response.result.fulfillment.speech;

                                var d = new Date();
                                var n = d.getMinutes();
                                var h = d.getHours();

                                var day = d.getDate();
                                var month = d.getMonth();



                                 $('.chat-message.padding').append("<div class='chat-message chat-message-recipient'>" +
    
                                        "<div class='chat-message-wrapper'>" +
                                        "<div class='chat-message-content'>" +
                                            "<p>"+reponse+"</p>" +
                                        "</div>" +

                                        "<div class='chat-details'>" +
                                            "<span class='chat-message-localization font-size-small'>"+h+":"+n+"</span>" +
                                            "<span class='chat-message-read-status font-size-small'>"+day+"/"+month+"</span>" +
                                        "</div>" +

                                        "</div>" +
                                    "</div>");

                                var wtf = $('#chatsc');
                                var height = wtf[0].scrollHeight;
                                console.log(height);
                                wtf.scrollTop(height);
                            },
                            function (error) {
                                
                                alert(error);
                            });
                    } catch (e) {
                        alert(e);
                    }
                }


                $('#micro').on('click', function(){

                    var id = localStorage.getItem('id');
                    
                    sendVoice(id);
                });

                function sendVoice(id) {
                    try {     

                        ApiAIPlugin.levelMeterCallback(function(level) {
                            console.log(level);
                        }); 

                        ApiAIPlugin.setListeningStartCallback(function () {
                        // Ici ça get la voix
                        });

                        ApiAIPlugin.requestVoice(
                        {
                            contexts: [id]
                        }, 
                        function (response) {  

                            var reponse = response.result.fulfillment.speech;

                            var d = new Date();
                            var n = d.getMinutes();
                            var h = d.getHours();

                            var day = d.getDate();
                            var month = d.getMonth();

                            var texte = response.metadata.resolvedQuery;

                            $('.chat-message.padding').append("<div class='chat-message chat-message-sender'>" +
                    
                                    "<div class='chat-message-wrapper'>" +
                                    "<div class='chat-message-content'>" +
                                        "<p>"+ texte +"</p>" +
                                    "</div>" +

                                " <div class='chat-details'>" +
                                        "<span class='chat-message-localisation font-size-small'>"+h+":"+n+"</span>" +
                                    " <span class='chat-message-read-status font-size-small'>"+day+"/"+month+"</span>" +
                                    "</div>" +
                                    "</div>" + 
                                "</div>");

                            var wtf = $('#chatsc');
                            var height = wtf[0].scrollHeight;
                            wtf.scrollTop(height);



                                $('.chat-message.padding').append("<div class='chat-message chat-message-recipient'>" +

                                    "<div class='chat-message-wrapper'>" +
                                    "<div class='chat-message-content'>" +
                                        "<p>"+reponse+"</p>" +
                                    "</div>" +

                                    "<div class='chat-details'>" +
                                        "<span class='chat-message-localization font-size-small'>"+h+":"+n+"</span>" +
                                        "<span class='chat-message-read-status font-size-small'>"+day+"/"+month+"</span>" +
                                    "</div>" +

                                    "</div>" +
                                "</div>");

                                var wtf = $('#chatsc');
                                var height = wtf[0].scrollHeight;
                                wtf.scrollTop(height);

                        },
                        function (error) {
                            
                            alert(error);
                        });                
                    } catch (e) {
                        alert(e);
                    }
                }



        </script>
    </body>
</html>